#!/usr/bin/python

import urllib2
import json

urlServices = '<%= @icinga_url_services %>'
urlHosts = '<%= @icinga_url_hosts %>'
username = '<%= @icinga_user %>'
password = '<%= @icinga_pass %>'

passman = urllib2.HTTPPasswordMgrWithDefaultRealm()
passman.add_password(None, urlServices, username, password)
passman.add_password(None, urlHosts, username, password)
urllib2.install_opener(urllib2.build_opener(urllib2.HTTPBasicAuthHandler(passman)))

req = urllib2.Request(urlServices)
f = urllib2.urlopen(req)
data = f.read()

parsed_data = json.loads(data)

print('# this output is generated by /usr/local/bin/get_services_with_workhours.py, probably by cron\n')

for service in parsed_data['config']['services']:
<% @downtimes.each do |downtimes_key, downtimes_value_hash| -%>
  if service['notification_period'] == '<%= downtimes_key -%>':
    print('define downtime {')
    print("        host_name            %s " % (service['host_name']) )
    print("        service_description  %s " % (service['service_description']) )
    print('        author               <%= downtimes_value_hash['author'] -%>')
    print('        comment              <%= downtimes_value_hash['comment'] -%>')
    <%- downtimes_value_hash['downtime_period'].each do |dtperiod| -%>
    print('        downtime_period      <%= dtperiod -%>')
    <%- end -%>
    print('        propagate            1')
    print('        register             1')
    print('}\n')
<% end -%>

req = urllib2.Request(urlHosts)
f = urllib2.urlopen(req)
data = f.read()

parsed_data = json.loads(data)

for host in parsed_data['config']['hosts']:
<% @downtimes.each do |downtimes_key, downtimes_value_hash| -%>
  if host['notification_period'] == '<%= downtimes_key -%>':
    print('define downtime {')
    print("        host_name            %s " % (host['host_name']) )
    print('        author               <%= downtimes_value_hash['author'] -%>')
    print('        comment              <%= downtimes_value_hash['comment'] -%>')
    <%- downtimes_value_hash['downtime_period'].each do |dtperiod| -%>
    print('        downtime_period      <%= dtperiod -%>')
    <%- end -%>
    print('        propagate            1')
    print('        register             1')
    print('}\n')
<% end -%>
